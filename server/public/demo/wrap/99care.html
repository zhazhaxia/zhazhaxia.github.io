<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>为爱点亮五彩世界-zhazhaxia</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="Content-Language" content="zh-cn" />
    <meta name="author" content="Tencent-ISUX-Music" />
    <meta name="Copyright" content="Tencent" />
    <meta name="applicable-device" content="mobile">
    <!--关键字和描述一定要写-->
    <meta name="description" content="色盲，关爱色盲宣传，H5，手机，HTML5，zhazhaxia" />
    <meta name="keywords" content="色盲，关爱色盲宣传，H5，手机，HTML5，zhazhaxia" />
    <!--如果该页面只适合在手机上进行浏览，请添加以下代码-->
    <meta name="applicable-device" content="mobile">
    <style type="text/css">
        html,body{ touch-action: none; font-family: '微软雅黑';}
        html,body{width:100%;height:100%;/*touch-action: none;*/}
        html,body,div,p,h1,span,section{margin:0;padding:0;font-family: "微软雅黑";}
        html,body,section{width:100%;height:100%;background: #000;}
        .container{position: relative;width: 100%;margin:0 auto;overflow: hidden;}
        .wrap{width: 100%;height:100%;position: relative;}
        .wrap-body{transform:translate3d(0px,0px,0px);transition:all 200ms ease-out;}

        
        .change-state{position: absolute;left: 0;bottom: 0;}
        .canvas-time{position: absolute;right: 0;top: 0;}
        .canvas-pop{position: absolute;left: 20%;top: 30%;}
        .wrap .wrap-title{text-align: center;font-size: 20px;padding:20px 0;}
        .wrap .wrap-content{text-indent:32px;font-size: 16px;margin:10px 0;}
        .wrap .wrap-contain{width:100%;text-align: center;margin:20px 0;position: absolute;bottom: 20px;}
        
        .wrap .wrap-img-content{text-align: center;padding:29px 25px 40px 0;}
        .wrap .wrap-img{transform: scale(0);transition: all 1s 2s;}

        .wrap-desc{width:100%;margin:40px;color: #fff;padding:0 20px;transition: all 1s 2.5s;opacity: 0;}
        .color-block{width:200px;height:200px;transition: all 2s;position: absolute;}
        .block1{left: -200px;top: -200px;background: rgb(66,178,96);}
        .block2{left: -200px;top: 400px;background: rgb(64,149,216);}
        .block3{left: 400px;top: -200px;background: rgb(128,73,193);}
        .block4{left: 400px;top: 400px;background: rgb(210,159,80);}
        .wrap1 .color-block{left:50%;top:130px;width:0px;height:0px;}
        .wrap1 .wrap-img{transform: scale(1);}

        .wrap1-text{width:20px;word-wrap: break-word;color: #fff;position: absolute;border-left: 1px solid #fff;border-right: 1px solid;padding: 0 5px;text-align: center;transition: all 1s 3s;bottom: -200px;opacity: 0;}
        .wrap1 .wrap1-text,.wrap1 .wrap-desc{opacity: 1;}
        .wrap1 .w-text1{bottom: 150px;left: 38%;}
        .wrap1 .w-text2{bottom: 100px;left: 52%;}

        .wrap2-text{width:30px;font-size:16px;word-wrap: break-word;color: #fff;position: absolute;/*border-left: 1px solid #fff;border-right: 1px solid #fff;*/padding: 0 5px;text-align: center;transition: all 1s 1s;top: -400px;opacity: 0;}
        .wrap2 .wrap2-text{opacity: 1;}
        .wrap2 .w-text1{top: 30px;left: 10%;/*color: rgb(98,190,229);*/}
        .wrap2 .w-text2{top: 60px;left: 20%;}
        .wrap2-img{position: absolute;bottom: -400px;right: 0;width:100%;transition: all 1s;}
        .wrap2 .wrap2-img{bottom:0px;} 
        .wrap-btn{width:50%;border-radius: 18px;border:1px solid #aaa;padding: 10px;color:#fff;opacity: 0;transition: all 1s 2s;}
        .wrap2 .wrap-btn{opacity: 1;}


        .game{width:100%;height:100%;display: none;}
        /*public*/

        .toast{position: absolute;top: 40%;left: 11%;width: 75%;padding: 10px;background: rgba(50,50,50,0.7);border-radius: 40px;color: #fff;text-align: center;word-wrap: break-word;display: none;}
        .success{position:absolute;background:url(../../img/bg.png) no-repeat;background-size:cover;width: 250px;height:150px;border:10px;color:#fff;padding:10px;top:30%;left:9%;display:none;border-radius: 10px;}
        .tototap,.toseerank{position: absolute;right: 10px;bottom: 10px;}
        .rule{position:absolute;background:url(../../img/bg.png) no-repeat;background-size:cover;width: 200px;height:100px;border:10px;color:#fff;padding:10px;top:30%;left:18%;display:none;border-radius: 10px;}
        .lamp{position: absolute;top: 0;right: 0;background:url(../../img/lamp.png) no-repeat;background-size:contain;width: 50px;height:100px; }
        

        .lastpage{width: 100%;height: 100%;background:url(../../img/bg2.png) no-repeat;background-size:contain;}
        .lastpage .title{padding-top:168px;text-align: center;color: #fff;font-size: 20px;}
        .lastpage .knowmore{margin:134px auto;background: ;width:50%;height:25px;padding: 5px;text-align: center;color: #333;border-radius: 30px;}
        .lastpage .done{margin:-132px auto;width:50%;height:25px;padding: 5px;text-align: center;color: #999999;border-radius: 5px;font-size: 14px;}
        .lastpage .llamp{position: absolute;top:20px;right: 20px;background:url(../../img/lamp.png) no-repeat;background-size:contain;width: 50px;height: 200px;}
        .lastpage .limg{text-align: center;margin: 177px auto;}
        .lastpage .lstar1{position: absolute;left: 100px;top: 100px;background:url(../../img/star.png) no-repeat;background-size:contain;width: 30px;height: 30px;}
        .lastpage .lstar2{position: absolute;left: 234px;top: 285px;background:url(../../img/star.png) no-repeat;background-size:contain;width: 30px;height: 30px;}
        .lastpage .lstar3{position: absolute;left: 50px;top: 300px;background:url(../../img/star.png) no-repeat;background-size:contain;width: 30px;height: 30px;}
        .lastpage .lstar4{position: absolute;left: 60px;top: 350px;background:url(../../img/star.png) no-repeat;background-size:contain;width: 30px;height: 30px;}
        .lastpage .lstar5{position: absolute;left: 150px;top: 450px;background:url(../../img/star.png) no-repeat;background-size:contain;width: 30px;height: 30px;}
    </style>
</head>
<body>

<section class="container" style="display:/*none*/;">
    <section class="wrap-body">

        <div class="wrap">
            <div class="wrap-img-content">
                <img src="../../img/semang.png" width="80%" class="wrap-img">
            </div>
            <div class="color-block block1"></div>
            <div class="color-block block2"></div>
            <div class="color-block block3"></div>
            <div class="color-block block4"></div>

            <!-- <div class="wrap1-text w-text1">每20个人就有</div>
            <div class="wrap1-text w-text2">1个是色盲</div> -->

            <div class="wrap-desc">在我们身边<br>每29个人就有一个是色盲或色弱<br>他们的世界没有五光十色……</div>
        </div>
        <div class="wrap">
            <div class="wrap2-img">
                <img src="../../img/wawa.png" width="100%">
            </div>
            <div class="wrap2-text w-text1">通过游戏为他们获得色盲矫正眼镜</div>
            <div class="wrap2-text w-text2">点亮五彩缤纷的世界</div>

            <div class="wrap-contain">
                <span class="wrap-btn j_to_experience">立即体验他们的世界</span>
            </div>
        </div>
    </section>
</section>
<div class="game" style="display:/*none*/;">
    <div class="change-state">change</div>
    <!-- <div class="canvas-pop">点我开始</div> -->
    <!-- <div class="canvas-time">剩余时间 <span></span>s</div> -->
    <canvas class="videoCanvas"></canvas>
</div>

<div class="lastpage" style="display:none;">
    <p class="title">您已经成为第<br><span class="num_you" style="font-size:36px;color:rgb(100,174,216);">5765675</span><br>位色盲患者的点亮者</p>

    <p class="knowmore">参与公益众筹</p>
    <p class="done">本活动已经为<span class="num_eyes">68743</span>位色盲患者提供色盲眼镜</p>
    <div class="llamp"></div>
    <div class="limg">
        <img src="../../img/logo.png" width="32%">
    </div>
    <div class="lstar1"></div>
    <div class="lstar2"></div>
    <!-- <div class="lstar3"></div> -->
    <div class="lstar4"></div>
    <!-- <div class="lstar5"></div> -->
</div>
<div class="toast j_toast"></div>
<div class="success">成功点亮<br><br>你为 <span class="rule_type">红色盲</span>患者点亮了五彩世界<br>继续为其他色盲患者点亮世界.  <div class="tototap">继续点亮</div></div>
<div class="rule">游戏规则<br><br>找出 <span class="rule_type">红色盲</span>眼中缺失的色块，为TA点亮五彩世界. <div class="lamp"></div></div>
<video class="video" src="" width="100" height="100" autoplay style="display:none;"></video>

<script src="//kg.qq.com/gtimg/music/kg/zepto.js?_bid=2241&max_age=31104000000"></script>  
<script type="text/javascript" src="//imgcache.gtimg.cn/music/kg/lib/sea-kg.js?max_age=31104000000"></script>
<script type="text/javascript">
define('main',function (require,exports,module) {
    var wrap = require('wrap')
    
    navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia;
    exports = module.exports = {
        init:function () {
            wrap.init({callback:exports.switchWrap});
            exports.initData();
            // exports.openMedia();
            exports.bind()
        },
        config:{
            width : $('body').width(),
            height : $('body').height(),
            timer:null,
            $video :$('.video'),
            $canvas:$('.videoCanvas'),
            ctx : $('.videoCanvas')[0].getContext('2d'),
            state:1,
            totalTime:5,
            result:[],//判断游戏是否通过
            hasOpenVideo:false
        },
        semang:{
            1:'全色盲',
            2:'红色盲',
            3:'绿色盲',
            4:'蓝色盲',
            5:'红绿色盲'
        },
        bind:function () {
            $(document).on('touchstart', '.change-state', function() {
                exports.config.state++
                console.log(exports.config.state)
                if (exports.config.state > 6) exports.config.state = 1;
            }).on('touchstart', '.videoCanvas', function(e) {
                e.preventDefault()
                e.stopPropagation()
                // console.log(e)
                if (exports.config.hasOpenVideo) {
                    exports.getTapColor({x:~~e.targetTouches[0].clientX,y:~~e.targetTouches[0].clientY});
                }
                
            }).on('touchstart', '.canvas-pop', function() {
                $(this).hide();
                var timer = setInterval(function(){
                    exports.config.totalTime--
                    $('.canvas-time span').text(exports.config.totalTime)
                    if (exports.config.totalTime === 0) {
                        // clearInterval(timer)
                        // alert('fail')
                    }
                },1000);
            }).on('touchstart', '.j_to_experience', function(event) {
                event.preventDefault();
                $('.wrap-body').animate({
                    opacity: 0},
                    500, function() {
                        $('.container').hide();
                        $('.game').show();
                        $('body').css('background','#fff')
                        exports.openMedia();
                });
            }).on('touchstart', '.tototap', function() {
                $('.success').hide();
                exports.config.state= ~~$(this).attr('data-state')
            }).on('touchstart', '.toseerank', function() {
                $('.success').hide();
                $('.game').animate({
                    opacity: 0},
                    500, function() {
                        $('.game').hide();
                        $('.lastpage').show();
                        $('body').css('background','#000')
                        var num_rnd=Math.ceil(Math.random()*1000000)
                        $('.num_eyes').text(num_rnd)
                        $('.num_you').text(Math.ceil(num_rnd/100))
                });

            });
        },
        initData:function () {
            exports.config.$canvas.attr({width:exports.config.width,height:exports.config.height})
            exports.config.$video.attr({width:exports.config.width,height:exports.config.height})

            $('.wrap').eq(0).addClass('wrap1')
            // $('.wrap').eq(0).addClass('wrap2')
        },
        switchWrap:function (idx) {
            switch (idx) {
                case 1:
                    $('.wrap').eq(0).addClass('wrap1')
                    setTimeout(function(){
                        $('.wrap').eq(1).removeClass('wrap2')
                    },1000)
                    break;
                case 2:
                    $('.wrap').eq(1).addClass('wrap2')
                    setTimeout(function(){
                        $('.wrap').eq(0).removeClass('wrap1')
                    },1000)
                    break;
                default:
                    // statements_def
                    break;
            }
            if (idx === 4) {
                exports.openMedia();
            }
        },
        openMedia:function () {
            if (exports.config.hasOpenVideo) return
            navigator.getUserMedia({audio:true,video:{width:exports.config.width,height:exports.config.height,facingMode: { exact: "environment" } }},function (stream) {
                var video = exports.config.$video[0]
                video.src = URL.createObjectURL(stream)
                video.onloadedmetadata = function () {
                    console.log('摄像头成功打开！');
                    exports.drawCanvasFromVideo(video);
                };
                exports.config.hasOpenVideo=true
            },function (err) {
                alert('摄像头成功失败！');
                console.log(err)
            })
        },
        drawCanvasFromVideo:function (video) {
            var ctx = exports.config.ctx;
            exports.config.state = 2//Math.ceil((Math.random()*10))%5 + 1;// 1-5

            $('.rule').html('游戏规则<br><br>找出 <span class="rule_type">'+exports.semang[exports.config.state]+'</span>眼中缺失的色块，为TA点亮五彩世界. ').show();
            setTimeout(function () {
                $('.rule').hide();
            }, 5000)

            $('.change-state').append('-'+exports.config.state)
            exports.config.timer = setInterval(function(){
                ctx.drawImage(video, 0, 0)
                
                var imgData=ctx.getImageData(0,0,exports.config.width,exports.config.height)
                exports.config.imgData = imgData
                switch (exports.config.state) {
                    case 1:
                        exports.convertToGray(imgData.data)
                        break;
                    case 2:
                        exports.convertToNoRed(imgData.data)
                        break;
                    case 3:
                        exports.convertToNoGreen(imgData.data)
                        break;
                    case 4:
                        exports.convertNoBlue(imgData.data)
                        break;
                    case 5:
                        exports.convertRedToGreen(imgData.data)
                        break;
                    case 6:
                        break;
                }
                // console.log(imgData)
                ctx.putImageData(imgData,0,0)
            },300);
        },
        getTapColor:function (opt) {
            var ctx = exports.config.ctx,
                w = exports.config.width,
                h = exports.config.height;
            var imgData=exports.config.imgData
            // console.log(imgData)
            var index = opt.x + (opt.y + 1)*w
            var r = imgData.data[index*4]
            var g = imgData.data[index*4+1]
            var b = imgData.data[index*4+2]
            exports.drawRec(imgData.data,opt,w,h)
            ctx.putImageData(imgData,0,0)


            // alert(r+'-'+g+'-'+b)
            $('.change-state').html(r+'-'+g+'-'+b)

            exports.judgeGame({r:r,g:g,b:b});
        },
        convertToGray:function (data) {//灰色 最严重
            var len=data.length
            var pixels=len/4
            var dataArr=new Array()
            for(var i=0;i<pixels;i++){
                var r=data[i*4]
                var g=data[i*4+1]
                var b=data[i*4+2]
                
                var gray=parseInt((11*r+16*g+5*b)/32)
                dataArr.push(gray)
            }

            for (var i=0;i<pixels;i++){
                data[i*4]=dataArr[i]
                data[i*4+1]=dataArr[i]
                data[i*4+2]=dataArr[i]
            }
        },
        convertToNoRed:function (data) {//去红
            var len=data.length
            var pixels=len/4
            var dataArr=new Array()
            for(var i=0;i<pixels;i++){
                data[i*4] =50
                data[i*4+1] = data[i*4+1]
                data[i*4+2] = data[i*4+2]
            }
        },
        convertToNoGreen:function (data) {//去绿
            var len=data.length
            var pixels=len/4
            var dataArr=new Array()
            for(var i=0;i<pixels;i++){
                data[i*4] = data[i*4]
                data[i*4+1] = 50
                data[i*4+2] = data[i*4+2]
            }
        },
        convertNoBlue:function (data) {//去蓝
            var len=data.length
            var pixels=len/4
            var dataArr=new Array()
            for(var i=0;i<pixels;i++){
                data[i*4] = data[i*4]
                data[i*4+1] = data[i*4+1]
                data[i*4+2] = 50
            }
        },
        convertRedToGreen:function (data) {//红绿交换
            var len=data.length
            var pixels=len/4
            var dataArr=new Array()
            for(var i=0;i<pixels;i++){
                data[i*4] = data[i*4]
                data[i*4+1] = data[i*4+1]
                data[i*4+2] = 50
                data[i*4] = data[i*4 + 1]
                data[i*4+1] = data[i*4]
                data[i*4+2] = data[i*4+2]
            }
        },
        drawRec:function(data,opt,w,h){
            var len=data.length
            var y = opt.y
            var x = opt.x
            var pixels=len/4
            var dataArr=new Array()
            var long = 10
            for(var i = y-long ; i < y+long ; i++){
                var index = opt.x-long + (i + 1)*w
                data[index*4] = 255
                data[index*4+1] = 255
                data[index*4+2] = 255
            }
            for(var i = y-long ; i < y+long ; i++){
                var index = opt.x+long + (i + 1)*w
                data[index*4] = 255
                data[index*4+1] = 255
                data[index*4+2] = 255
            }

            for(var i = x-long ; i < x+long ; i++){
                var index = i + (opt.y - long)*w
                data[index*4] = 255
                data[index*4+1] = 255
                data[index*4+2] = 255
            }
            for(var i = x-long ; i < x+long ; i++){
                var index = i + (opt.y + long)*w
                data[index*4] = 255
                data[index*4+1] = 255
                data[index*4+2] = 255
            }

        },
        judgeGame:function(opt){
            // console.log(opt)
            var ok = false;
            var min = 100 ,max = 150;
            switch (exports.config.state) {
                case 1://gray
                    if (opt.r > max && opt.g < min && opt.b < min)exports.config.result.push(1)
                    if (opt.r < min && opt.g >max && opt.b < min)exports.config.result.push(2)
                    if (opt.r < min && opt.g < min && opt.b > max)exports.config.result.push(3)

                    if (exports.config.result.length === 3 ){
                        ok = true
                    }
                    break;
                case 2://red
                    if (opt.r > max && opt.g < min && opt.b < min) {
                        ok = true
                    }
                    break;
                case 3://green
                    if (opt.r < min && opt.g >max && opt.b < min) {
                        exports.config.state = 6
                        ok = true
                    }
                    break;
                case 4://blue
                    if (opt.r < min && opt.g < min && opt.b > max) {
                        ok = true
                    }
                    break;
                case 5://red green
                    if (opt.r > max && opt.g < min && opt.b < min)exports.config.result.push(1)
                    if (opt.r < min && opt.g >max && opt.b < min)exports.config.result.push(2)

                    if (exports.config.result.length === 2 ){
                        ok = true
                    }
                    break;
            }
            ok=true
            if (!ok) {
                $('.j_toast').text('所选颜色错误，请试试其他颜色看看能否治愈当前色盲患者哦').show();
                setTimeout(function(){$('.j_toast').hide();} , 2000)
            }else {
                $('.success').html('成功点亮<br><br>你为 <span class="rule_type">红色'+exports.semang[exports.config.state]+'</span>患者点亮了五彩世界<br>继续为其他色盲患者点亮世界.  <div class="'+(exports.config.state == 4 ? 'toseerank' : "tototap")+'" data-state="'+(exports.config.state+1)+'">'+(exports.config.state == 4 ? '查看排名' : "继续点亮")+'</div>').show();
                exports.config.state = 6
            }
        }
    }
})
define('wrap',function (require,exports,module) {
    var option = {};
    exports = module.exports = {
        init:function (opt) {
            Object.assign(option,opt || {})
            // console.log(option)
            exports.initWrap()
            exports.bind();
        },
        config:{
            index:0
        },
        initWrap:function () {
            var $container = $('.container'),
                $wrap = $('.wrap')
            $wrap.height($container.height())
            
            $('.wrap-body').height($wrap.length*$container.width())
        },
        bind:function () {
            $(document.body).on('touchstart', function(e) {
                // console.log(e)
                e.preventDefault();
                e.stopPropagation()
                var sY = e.touches[0].clientY,
                    offset = 0,
                    $wrap = $('.wrap-body'),
                    nowTop = exports.getTop($wrap.css('transform')),
                    isHeadOrEnd = false;//到达开头或者末尾了
                $wrap.css('transition',"")
                $(document.body).on('touchmove', function(e) {
                e.preventDefault();
                    offset = e.targetTouches[0].clientY - sY;
                    $wrap.css('transform','translate3d(0px,'+(nowTop + offset) + 'px,0px)')
                })
                $(document.body).on('touchend', function(e) {
                    // console.log(e)
                e.preventDefault();
                    $wrap.css('transition',"all 200ms ease-out")
                    offset = e.changedTouches[0].clientY - sY;
                    if (offset > 0) {
                        if(Math.abs(offset) > 100){
                            exports.config.index--;
                            if (exports.config.index < 0 ) {
                                exports.config.index = 0
                                isHeadOrEnd = true
                            }
                        }
                        $wrap.css('transform','translate3d(0px,'+(-exports.config.index*$('body').height()) + 'px,0px)')
                    }else {
                        if(Math.abs(offset) > 100) {
                            exports.config.index++;
                            if (exports.config.index > ($('.wrap').length-1) ) {
                                exports.config.index = $('.wrap').length-1
                                isHeadOrEnd = true
                            }
                        }
                        $wrap.css('transform','translate3d(0px,'+(-exports.config.index* $('body').height()) + 'px,0px)')
                    }
                    if (!isHeadOrEnd && Math.abs(offset) > 100) option.callback(exports.config.index + 1);//回调
                    // $wrap.css('transform','translate3d(0px,'+(nowTop + offset) + 'px,0px)')
                    $(document.body).off('touchend')
                })
            })
        },
        getTop:function (top) {
            return top.indexOf('matrix') >=0 ? parseInt(top.match(/(-?\d)+/ig)[5]) : parseInt(top.match(/(-?\d)+/ig)[2])
        }
    }
})
seajs.use('main',function (ex) {
    ex.init()
})
</script>
</body>
</html>
