<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <title>八音符-H5游戏</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="Content-Language" content="zh-cn" />
    <meta name="author" content="Tencent-ISUX-Music" />
    <meta name="Copyright" content="Tencent" />
    <meta name="applicable-device" content="mobile">
    <!--关键字和描述一定要写-->
    <meta name="description" content="八音符，游戏，H5，手机" />
    <meta name="keywords" content="八音符，游戏，H5，手机" />
    <!--如果该页面只适合在手机上进行浏览，请添加以下代码-->
    <meta name="applicable-device" content="mobile">
    <style type="text/css">
        html,body,div,p,h1,span,section{margin:0;padding:0;font-family: "微软雅黑";}
        html,body,section{width:100%;height:100%;}
        .container{position: relative;width: 100%;margin:0 auto;background: -webkit-linear-gradient( top,rgb(102,143,250),rgb(233,201,211));overflow: hidden;}
        .title{text-align: center;}
        .bottom-barrier{height: 200px;width:/*200%*/;position: absolute;bottom: 0;left: 0;display: flex;flex-direction:row;flex-wrap: nowrap;justify-content:flex-start;align-items:flex-end;}
        .barrier{width: 80px;}
        .barrier-high{background: -webkit-linear-gradient( top,rgb(39,40,34),rgb(66,63,40));height: 100%;}
        .barrier-low{height: 1px;}
        .notes{width: 80px;height: 80px;position: absolute;left: 80px;bottom: 200px;background-color: orange;background-image: url(https://gss0.baidu.com/-vo3dSag_xI4khGko9WTAnF6hhy/zhidao/pic/item/314e251f95cad1c8eaa2af64793e6709c93d5153.jpg);background-size: cover;}
        .bqb{width:100px;height:100px;position: absolute;background-size: cover;display:none;}
        .bqb1{left: 100%;top:100px;background-image: url(https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1488125181085&di=4c969729aa1e44e755edb66eaf1fbd41&imgtype=0&src=http%3A%2F%2Fp2.image.hiapk.com%2Fuploads%2Fallimg%2F160906%2F7730-160Z61Q522.jpg);-webkit-animation:a_a 6s linear 0s infinite normal;}
        .bqb2{left: 100%;top:150px;background-image: url(https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1488125218691&di=ffe4ecef48c0fc39e3f64affe7de994f&imgtype=0&src=http%3A%2F%2Fimg1.gamersky.com%2Fimage2015%2F09%2F20150927lll_1%2Fgamersky_36small_72_20159271559BBC.jpg);-webkit-animation:a_a 10s linear 10s infinite normal;}
        .bqb3{left: 100%;top:50px;background-image: url(https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1488125218690&di=a252e2ac805aba87f0fdb55703fcccae&imgtype=0&src=http%3A%2F%2Fwww.yoka.com%2Fdna%2Fpics%2Fmedia%2Fba15a7b3%2F26%2Fd3573b77bde3ed777b.jpg);-webkit-animation:a_a 15s linear 15s infinite normal;}
        .bqb4{left: 100%;top:150px;background-image: url(https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=3331638148,3229112911&fm=23&gp=0.jpg);-webkit-animation:a_a 10s linear 25s infinite normal;}
        .bqb5{left: 100%;top:100px;background-image: url(https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1488125742263&di=6a6909f1b71ef08875e1e17b297118d2&imgtype=0&src=http%3A%2F%2Fimg.tupianzj.com%2Fuploads%2Fallimg%2F160228%2F9-16022QP524-50.jpg);-webkit-animation:a_a 5s linear 20s infinite normal;}
        .bqb6{left: 100%;top:50px;background-image: url(https://timgsa.baidu.com/timg?image&quality=80&size=b9999_10000&sec=1488125764779&di=6978a87ecf4d029d3f8dae7ecb19fe28&imgtype=0&src=http%3A%2F%2Fwww.fuhaodq.com%2Fd%2Ffile%2Fqqbq%2F2015-12-29%2F6be5e3e2ef15520a127e2d823de952af.jpg);-webkit-animation:a_a 20s linear 30s infinite normal;}
        @keyframes a_a{
            0%{left:100%;}
            100%{left:-100%;}
        } 
    </style>
</head>
<body>
<section class="container">
    <h1 class="title">八音符游戏 <p style="color:#333;font-size:14px;" class="t-alert">(建议你带着耳麦说几句)</p></h1>
    <h2 class="ttt"></h2>
    <div class="bqb bqb1"></div>
    <div class="bqb bqb2"></div>
    <div class="bqb bqb3"></div>
    <div class="bqb bqb4"></div>
    <div class="bqb bqb5"></div>
    <div class="bqb bqb6"></div>
    <div class="notes"></div>
    <div class="bottom-barrier">
    </div>
</section>


<script src="//kg.qq.com/gtimg/music/js/lib/jquery-min.js?max_age=31104000000"></script>  
<script type="text/javascript" src="//kg.qq.com/js/lib/sea-kg.js?max_age=31104000000"></script>
<script>
</script>
<script type="text/javascript">
define("main",function (require, exports, module) {
    var $notes = $('.notes'),//音符
        $bottomBarrier = $('.bottom-barrier');

    navigator.getUserMedia = (navigator.getUserMedia ||
                       navigator.webkitGetUserMedia ||
                       navigator.mozGetUserMedia ||
                       navigator.msGetUserMedia);

    exports = module.exports = {
        init:function () {
            exports.bind();
            exports.initStat();
            exports.getSpeaker();
        },
        config:{
            barrierWidth:80,
            containerWidth:$('.container').width(),//大容器宽
            numberOfBarrier:0,//容器障碍物数目
            rank : 2,//难度1,2,3
            timer:null,
            lockMove:false,
            lockLost:false,//坑来了，开始判断
            dangerArea:[null,null],//危险区域
            $tmpBarrier:$(".barrier-low"),
            lockConsole:true,
            volSum:0,
            vol:0,
            gameEnd:false
        },
        audioContext:new AudioContext(),
        audio:new Audio(),
        bind:function () {
            $(document).on('keydown', function(e) {//keyCode = 38 上，39 下
                e.preventDefault();
                if (e.keyCode === 39) {
                    exports.moveBarrier();
                }
                if (e.keyCode === 38) {
                    exports.jumpNotes();
                }
                if (e.keyCode === 32) {
                    exports.config.lockConsole = !exports.config.lockConsole;
                }
            }).on('keyup', function(e) {
                e.preventDefault();
                if (e.keyCode === 39) {
                    exports.stopBarrier();
                }
            });
        },
        initStat:function () {
            $('.barrier').width(exports.config.barrierWidth);
            exports.config.numberOfBarrier = Math.ceil(exports.config.containerWidth / exports.config.barrierWidth) + 2;
            $('.bottom-barrier').width(exports.config.numberOfBarrier * exports.config.barrierWidth);//障碍物容器宽
            exports.createBarrier(exports.config.numberOfBarrier);
        },
        getAudio:function () {
            var source = exports.audioContext.createMediaElementSource(exports.audio);
            source.connect(exports.audioContext.destination);
        },
        getSpeaker:function () {
            
            if(!navigator.getUserMedia){alert('不支持麦克风录音');return;}
            navigator.getUserMedia({audio:true}, function (stream) {
                console.log(stream);

                var source=exports.audioContext.createMediaStreamSource(stream);
                //用于录音的processor节点
                var recorder=exports.audioContext.createScriptProcessor(1024,1,1);
                source.connect(recorder);


                var analyser = exports.audioContext.createAnalyser();
                recorder.connect(analyser);
                // source.connect(analyser);
                // 让扬声器的音频通过分析器
                analyser.connect(exports.audioContext.destination);

                // 设置数据
                analyser.fftSize = 1024;//频道数量
                bufferLength = analyser.fftSize;
                dataArray = new Float32Array(bufferLength);//每个频道的频率


                // recorder.connect(exports.audioContext.destination)
                recorder.onaudioprocess=function(e){
                    var inputBuffer = e.inputBuffer;
                    // console.log(inputBuffer)
                    var ave = 0;
                    var outputBuffer = e.outputBuffer;
                    for (var channel = 0; channel < outputBuffer.numberOfChannels; channel++) {
                        var inputData = inputBuffer.getChannelData(channel);
                        var outputData = outputBuffer.getChannelData(channel);
                        for (var sample = 0; sample < inputBuffer.length; sample++) {
                          outputData[sample] = inputData[sample];
                          ave += inputData[sample]
                        }
                        analyser.getFloatTimeDomainData(dataArray);
                        if(exports.config.lockConsole){
                            var multi = exports.getAverage(dataArray) * 1000;
                            if (multi < 0) return;
                            exports.getVolume(multi);
                        }
                    }
                };
            },function (err) {
                console.log('err',err)
            });
        },
        getVolume:function (data) {
            var total = 4;
            exports.config.volSum++;
            exports.config.vol += data;
            if (exports.config.volSum >= total) {
                exports.config.volSum = 0;
                exports.letsGo(exports.config.vol / total);
                exports.config.vol = 0;
            }
        },
        letsGo:function (vol) {
            console.log(vol)
            //$('.ttt').text(vol)
            if (vol > 1 ) {//走
                exports.moveBarrier();
                if (vol > 10) {//跳
                    console.log('jump')
                    exports.jumpNotes();
                }
            }else {//停
                exports.stopBarrier();
            }
        },
        jumpNotes:function () {
            if(exports.config.gameEnd)return;
            var bottom = parseInt($notes.css("bottom")),
                height = 100;
            if (bottom >= 200 + height) return;
            $notes.stop(true).animate({bottom:bottom+height},500,"swing",function(){
                $notes.animate({bottom:200},500,"linear",function(){
                    exports.judgeLost();
                })
            })
        },
        judgeLost:function(){
            var $barrier = $bottomBarrier.children().eq(2);
            var step = 4;
            if ($barrier.hasClass('barrier-high')) {
                exports.config.lockLost = false;
                exports.config.dangerArea = [null,null];
                return;
            }
            if(exports.config.$tmpBarrier.attr('data-id') !== $barrier.attr("data-id")){
                exports.config.$tmpBarrier = $barrier;
                exports.config.lockLost = true;
                exports.config.dangerArea[0] = (exports.config.dangerArea[0] !== null ? exports.config.dangerArea[0] : $barrier.offset().left);
                exports.config.dangerArea[1] = (exports.config.dangerArea[1] !== null ? exports.config.dangerArea[1] + exports.config.barrierWidth: exports.config.dangerArea[0] + exports.config.barrierWidth);
            }
            exports.config.dangerArea[0] = exports.config.dangerArea[0] - step;
            exports.config.dangerArea[1] = exports.config.dangerArea[1] - step;
            if (parseInt($notes.css("bottom")) <= 200) {//判断是否在区间
                var left = exports.config.dangerArea[0],
                    right = exports.config.dangerArea[1];
                // console.log(left,right)
                if(left <= 80 && right >= 160){
                    console.log("lost!!!!!!!!")
                    $('.title').text('啊！掉坑了！重新来一遍吧！')
                    exports.config.gameEnd = true;
                    setTimeout(function () {
                        location.href = "https://zhazhaxia.github.io/public/demo/8notes.html?a="+new Date().getTime();
                    }, 2000)
                }
            }
        },
        moveBarrier:function () {
            if(exports.config.gameEnd)return;
            var $b = $('.bottom-barrier'),
                step = 4;
            if (exports.config.lockMove) return;
            exports.config.lockMove = true;
            exports.config.timer = setInterval(function () {
                $b.css('left', parseInt($b.css("left")) - step);
                if (parseInt($b.css("left")) <= -exports.config.barrierWidth) {//删掉第一个元素然后随机填充最后一个。
                    $b.children().eq(0).remove();
                    $b.css("left",0)
                    $b.append(exports.createBarrier(1));
                }
                exports.judgeLost();

            }, 30);
        },
        stopBarrier:function () {
            exports.config.lockMove = false;
            clearInterval(exports.config.timer);
        },
        createBarrier:function (num) {//创建障碍物，num个数
            var $bc = $('.bottom-barrier'),
                random = parseInt(Math.random()*10),
                type = 1;
            if (num <= 1) {
                num = 1;//没有指定个数默认为1个
                switch (exports.config.rank) {
                    case 1:
                        type = random >= 3 ? 1 : 2;
                        break;
                    case 2:
                        type = random >= 4 ? 1 : 2;
                        break;
                    case 3:
                        type = random >= 5 ? 1 : 2;
                        break;
                }
            }
            $bc.append(exports.getBarrier(num,type));
        },
        getBarrier:function (num,type) {//获取障碍物
            var html = "";
            for(var i = 0; i < num; i++){
                html += '<div class="barrier '+(type === 1 ? "barrier-high" : "barrier-low")+'" data-id="'+new Date().getTime()+'"></div>'
            }
            return html;
        },
        getAverage:function (arr) {
            var sum = 0;
            for(var i = 0,len = arr.length; i < len; i++){
                sum += arr[i];
            }
            return sum / arr.length;
        }
    }
});
seajs.use("main",function (ex) {
    ex.init();
})
</script>
</body>
</html>
